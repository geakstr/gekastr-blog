<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Forkbomb Blog</title><link>http://dkharitonov.me/</link><description></description><atom:link href="http://dkharitonov.me/feeds/rss.xml" rel="self"></atom:link><lastBuildDate>Tue, 25 Aug 2015 12:00:00 +0300</lastBuildDate><item><title>Делаем Raspberry Pi доступным из интернета при динамичном IP</title><link>http://dkharitonov.me/blog/yandex-dns-for-raspberry-pi</link><description>&lt;p&gt;Если вы&amp;nbsp;хотите сделать пай доступным извне по&amp;nbsp;доменному имени, у&amp;nbsp;вас не&amp;nbsp;статичный&amp;nbsp;IP и&amp;nbsp;есть, собственно, домен, который можно делегировать, то, как вариант, предлагаю воспользоваться сервисом от&amp;nbsp;Яндекса&amp;nbsp;&amp;mdash; &lt;a href="https://pdd.yandex.ru"&gt;Почта для домена&lt;/a&gt;. Помимо предоставления почты Яндекс позволяет настраивать DNS параметры домена через REST API&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;бесплатно).&lt;/p&gt;
&lt;p&gt;Этим мы&amp;nbsp;и&amp;nbsp;воспользуемся, написав соответствующий скрипт, который будет автоматически обновлять&amp;nbsp;IP адрес пая в&amp;nbsp;DNS Яндекса. Для начала, конечно, домен должен быть делегирован Яндексу. &lt;a href="https://yandex.ru/support/pdd/hosting.xml"&gt;Тут&lt;/a&gt; написано как это сделать.&lt;/p&gt;
&lt;p&gt;Создадим скрипт:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;mkdir ~/bin &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; ~/bin &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; nano ya_dns
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Тело скрипта:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/env bash&lt;/span&gt;

&lt;span class="c"&gt;# Использование:&lt;/span&gt;
&lt;span class="c"&gt;# ./ya_dns &amp;lt;id&amp;gt; &amp;lt;domain&amp;gt; &amp;lt;subdomain&amp;gt; &amp;lt;ttl&amp;gt;&lt;/span&gt;

&lt;span class="c"&gt;# Получим токен для доступа к API&lt;/span&gt;
&lt;span class="c"&gt;# Нужно заменить &amp;lt;yourdomain.com&amp;gt; на имя домена&lt;/span&gt;
&lt;span class="c"&gt;# https://pddimp.yandex.ru/token/index.xml?domain=&amp;lt;yourdomain.com&amp;gt;&lt;/span&gt;
&lt;span class="nv"&gt;token&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&amp;lt;put token here&amp;gt;&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Посмотреть информацию о DNS параметрах тут&lt;/span&gt;
&lt;span class="c"&gt;# Необходимо найти A запись для нужного домена/поддомена.&lt;/span&gt;
&lt;span class="c"&gt;# Для использования скрипта нужно узнать следующее: id, domain, subdomain, ttl&lt;/span&gt;
&lt;span class="c"&gt;# https://pddimp.yandex.ru/nsapi/get_domain_records.xml?token=&amp;lt;your_token_here&amp;gt;&amp;amp;domain=&amp;lt;yourdomain.com&amp;gt;&lt;/span&gt;

&lt;span class="c"&gt;# Подробнее про редактирование записи по API можно почитать тут:&lt;/span&gt;
&lt;span class="c"&gt;# https://tech.yandex.ru/pdd/doc/reference/dns-edit-docpage/&lt;/span&gt;

&lt;span class="nv"&gt;args&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$@&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# Тут будем хранить IP&lt;/span&gt;
&lt;span class="nv"&gt;ip_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/tmp/cur_ip.txt&amp;quot;&lt;/span&gt;

&lt;span class="nv"&gt;old_ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;cat &lt;span class="nv"&gt;$ip_file&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# Получим текущий IP&lt;/span&gt;
&lt;span class="nv"&gt;cur_ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;/usr/bin/curl -sL http://icanhazip.com&lt;span class="k"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# Если IP изменился с прошлого раза&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$cur_ip&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; !&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$old_ip&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="k"&gt;then&lt;/span&gt;
  &lt;span class="c"&gt;# Сохраним новый IP&lt;/span&gt;
  &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$cur_ip&lt;/span&gt; &amp;gt; &lt;span class="nv"&gt;$ip_file&lt;/span&gt;

  &lt;span class="nv"&gt;record_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[0]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
  &lt;span class="nv"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[1]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
  &lt;span class="nv"&gt;subdomain&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[2]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
  &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[3]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

  &lt;span class="c"&gt;# Обновим IP на яндексе&lt;/span&gt;
  &lt;span class="nv"&gt;ya_pdd_url&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;https://pddimp.yandex.ru/nsapi/edit_a_record.xml?&amp;quot;&lt;/span&gt;
  &lt;span class="nv"&gt;query_url&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;ya_pdd_url&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;token=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;token&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;amp;record_id=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;record_id&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;amp;domain=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;domain&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;amp;subdomain=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;subdomain&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;amp;ttl=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;amp;content=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;cur_ip&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
  &lt;span class="nv"&gt;ya_pdd_response&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;/usr/bin/curl -sL &lt;span class="nv"&gt;$query_url&lt;/span&gt;&lt;span class="k"&gt;)&lt;/span&gt;

  &lt;span class="c"&gt;#echo $ya_pdd_response&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Делаем скрипт исполняемым &lt;code&gt;chmod +x ./ya_dns&lt;/code&gt;, и&amp;nbsp;используем так: &lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;./ya_dns &amp;lt;id&amp;gt; &amp;lt;domain&amp;gt; &amp;lt;subdomain&amp;gt; &amp;lt;ttl&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Остается добавить его на&amp;nbsp;запуск по&amp;nbsp;расписанию: &lt;code&gt;crontab -e&lt;/code&gt;&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1
2&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Запускать каждые 5 минут&lt;/span&gt;
*/5 * * * * /home/pi/bin/ya_dns &amp;lt;id&amp;gt; &amp;lt;domain&amp;gt; &amp;lt;subdomain&amp;gt; &amp;lt;ttl&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Не&amp;nbsp;забудьте открыть нужные вам порты на&amp;nbsp;устройстве, с&amp;nbsp;помощью которого подключаетесь к&amp;nbsp;интернету.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;nobr&gt;P. S.&lt;/nobr&gt; Если у&amp;nbsp;вас нет домена, но&amp;nbsp;все&amp;nbsp;же хотите иметь доступ к&amp;nbsp;паю, можно переделать скрипт так, чтобы пай отправлял вам смс с&amp;nbsp;новым&amp;nbsp;IP&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;например, через &lt;a href="http://sms.ru/?panel=main&amp;amp;subpanel=programmer"&gt;sms.ru&lt;/a&gt;). Или еще что-нибудь такое.&lt;/em&gt;&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Дмитрий Харитонов</dc:creator><pubDate>Tue, 25 Aug 2015 12:00:00 +0300</pubDate><guid>tag:dkharitonov.me,2015-08-25:blog/yandex-dns-for-raspberry-pi</guid><category>rpi</category><category>nix</category><category>dns</category><category>yandex</category></item><item><title>Вдумчивая настройка Raspberry Pi</title><link>http://dkharitonov.me/blog/raspberry-pi-setup</link><description>&lt;h3&gt;Скачиваем и&amp;nbsp;конфигурируем образ&lt;/h3&gt;
&lt;p&gt;Детально про используемый образ можно почитать &lt;a href="https://github.com/debian-pi/raspbian-ua-netinst"&gt;в&amp;nbsp;репозитории проекта&lt;/a&gt;. Для начала необходимо узнать номер последней версии образа &lt;a href="https://github.com/debian-pi/raspbian-ua-netinst/releases/latest"&gt;тут&lt;/a&gt;.&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Замените &amp;lt;version-number&amp;gt; на номер версии&lt;/span&gt;
&lt;span class="nv"&gt;rpi_inst_v&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;v&amp;lt;version-number&amp;gt;

&lt;span class="c"&gt;# Скачиваем образ&lt;/span&gt;
wget https://github.com/debian-pi/raspbian-ua-netinst/releases/download/&lt;span class="nv"&gt;$rpi_inst_v&lt;/span&gt;/raspbian-ua-netinst-&lt;span class="nv"&gt;$rpi_inst_v&lt;/span&gt;.zip

&lt;span class="c"&gt;# Разархивируем&lt;/span&gt;
unzip raspbian-ua-netinst-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;rpi_inst_v&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.zip -d ./raspbian-ua-netinst-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;rpi_inst_v&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="nb"&gt;cd &lt;/span&gt;raspbian-ua-netinst-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;rpi_inst_v&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

&lt;span class="c"&gt;# Укажем пароль (свой) для root пользователя&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;rootpw=&amp;lt;password&amp;gt;&amp;quot;&lt;/span&gt; &amp;gt; ./installer-config.txt

&lt;span class="c"&gt;# (опционально) Указываем имя дистрибутива и дополнительные нужные вам пакеты&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;release=wheezy&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; ./installer-config.txt
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;packages=sudo,curl,nano&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; ./installer-config.txt
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h3&gt;Записываем образ на&amp;nbsp;SD карту&lt;/h3&gt;
&lt;p&gt;Инструкция для&amp;nbsp;OS X. Всё это можно сделать и&amp;nbsp;через GUI.&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Узнаём имя карточки (/dev/diskX, где X — число)&lt;/span&gt;
diskutil list

&lt;span class="c"&gt;# Форматируем в FAT 32&lt;/span&gt;
diskutil eraseDisk FAT32 RPI MBRFormat /dev/diskX

&lt;span class="c"&gt;# Копируем образ на карточку&lt;/span&gt;
cp -R ./* /Volumes/RPI

&lt;span class="c"&gt;# И извлекаем её&lt;/span&gt;
diskutil eject /dev/diskX
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Теперь вставляем карту в&amp;nbsp;пай и&amp;nbsp;ждем. Если он&amp;nbsp;подключен к&amp;nbsp;телевизору, сможете наблюдать за&amp;nbsp;процессом. Если нет, можно посматривать на&amp;nbsp;лампочку Ethernet на&amp;nbsp;пае, и&amp;nbsp;когда она перестанет хаотично мигать, скорее всего можно идти дальше. Установка занимает минут 15.&lt;/p&gt;
&lt;h3&gt;Первоначальная настройка&lt;/h3&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Заходим на пай (пароль тот, что указали вначале)&lt;/span&gt;
ssh root@pi.ip.addr.ess

&lt;span class="c"&gt;# Обновим пакеты&lt;/span&gt;
apt-get update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt-get dist-upgrade &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt-get upgrade

&lt;span class="c"&gt;# Обновим ядро и прошивку&lt;/span&gt;
&lt;span class="c"&gt;# Не используйте утилиту rpi-update, она не работает с этим оразом (https://github.com/debian-pi/raspbian-ua-netinst/issues/267)&lt;/span&gt;
&lt;span class="c"&gt;# Вместо этого воспользуемся пакетом raspberrypi-bootloader.&lt;/span&gt;
&lt;span class="c"&gt;# Он включает в себя ядро и прошивку. Это пакет проекта raspberry pi на github (https://github.com/raspberrypi/linux)&lt;/span&gt;
apt-get install -y raspberrypi-bootloader
sed -i &lt;span class="s1"&gt;&amp;#39;s/kernel=/#kernel=/g&amp;#39;&lt;/span&gt; /boot/config.txt
sed -i &lt;span class="s1"&gt;&amp;#39;s/initramfs /#initramfs /g&amp;#39;&lt;/span&gt; /boot/config.txt

&lt;span class="c"&gt;# Сконфигурируем локали и временную зону&lt;/span&gt;
dpkg-reconfigure locales
dpkg-reconfigure tzdata

&lt;span class="c"&gt;# Добавим нового пользователя&lt;/span&gt;
groupadd pi
useradd pi -m -K &lt;span class="nv"&gt;UMASK&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0066&lt;/span&gt; -s /bin/bash -g pi -G users,ssh,sudo
passwd pi

&lt;span class="c"&gt;# Перезагрузимся, чтобы изменения вступили в силу&lt;/span&gt;
reboot

&lt;span class="c"&gt;# Теперь можно зайти на пай под новым пользователем&lt;/span&gt;
ssh pi@pi.ip.addr.ess
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h3&gt;Настраиваем SSH&lt;/h3&gt;
&lt;p&gt;Если смогли успешно войти под пользователем &lt;code&gt;pi&lt;/code&gt; на&amp;nbsp;предыдущем шаге, можно приступить к&amp;nbsp;дальшейшей настройке. Усилим безопасность системы.&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Запретим входить под рутом&lt;/span&gt;
sudo sed -i &lt;span class="s1"&gt;&amp;#39;s/PermitRootLogin yes/PermitRootLogin no/g&amp;#39;&lt;/span&gt; /etc/ssh/sshd_config

&lt;span class="c"&gt;# Можно разрешить сессии только определенным юзерам&lt;/span&gt;
&lt;span class="c"&gt;# [ОПАСНАЯ ОПЦИЯ, проверьте правильность имен несколько раз]&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;AllowUsers root pi&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sudo tee --append /etc/ssh/sshd_config

&lt;span class="c"&gt;# Можно ограничить время бездействия пользовательской сессии (здесь 5 минут)&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ClientAliveInterval 300&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sudo tee --append /etc/ssh/sshd_config &amp;gt; /dev/null
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ClientAliveCountMax 0&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sudo tee --append /etc/ssh/sshd_config &amp;gt; /dev/null

&lt;span class="c"&gt;# Перезапустим SSH демон&lt;/span&gt;
sudo /etc/init.d/ssh restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h4&gt;Настраиваем авторизацию по&amp;nbsp;ключу&lt;/h4&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# На _своей_ машине сгенерируем ключ (если еще этого не делали)&lt;/span&gt;
&lt;span class="c"&gt;# Не оставляем пароль ключа пустым&lt;/span&gt;
mkdir .ssh
ssh-keygen -t rsa -C &lt;span class="s2"&gt;&amp;quot;your_email@example.com&amp;quot;&lt;/span&gt;
ssh-add ~/.ssh/id_rsa
&lt;span class="c"&gt;# Скопируем свой _публичный_ ключ в буфер обмена&lt;/span&gt;
pbcopy &amp;lt; ~/.ssh/id_rsa.pub

&lt;span class="c"&gt;# Дальнейшие действия делаем на пае под пользователем pi&lt;/span&gt;
mkdir ~/.ssh

&lt;span class="c"&gt;# Сюда вставим в новую строку скопированный публичный ключ&lt;/span&gt;
nano ~/.ssh/authorized_keys

&lt;span class="c"&gt;# Выставим правильные права&lt;/span&gt;
chmod &lt;span class="m"&gt;700&lt;/span&gt; ~/.ssh/
chmod &lt;span class="m"&gt;600&lt;/span&gt; ~/.ssh/authorized_keys

&lt;span class="c"&gt;# Пробуем выйти и зайти опять, должно пустить без пароля&lt;/span&gt;

&lt;span class="c"&gt;# Можно запретить вход по паролю, разрешить только по ключу&lt;/span&gt;
&lt;span class="c"&gt;# Нужно помнить, что в случае, если у нас не останется&lt;/span&gt;
&lt;span class="c"&gt;# ни одного авторизованного на пае ключа, по SSH войти не сможем&lt;/span&gt;
sudo sed -i &lt;span class="s1"&gt;&amp;#39;s/#PasswordAuthentication yes/PasswordAuthentication no/g&amp;#39;&lt;/span&gt; /etc/ssh/sshd_config
sudo sed -i &lt;span class="s1"&gt;&amp;#39;s/UsePAM yes/UsePAM no/g&amp;#39;&lt;/span&gt; /etc/ssh/sshd_config

&lt;span class="c"&gt;# Перезапустим SSH демон&lt;/span&gt;
sudo /etc/init.d/ssh restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Всё дальнейшее&amp;nbsp;&amp;mdash; опционально&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;впрочем, как и&amp;nbsp;всё, что выше). Ваши потребности естественно могут отличаться от&amp;nbsp;моих, поэтому выполняем команды &lt;em&gt;вдумчиво&lt;/em&gt;. Рекомендую для удобства действовать от&amp;nbsp;рута&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;&lt;code&gt;su&amp;nbsp;root&lt;/code&gt;).&lt;/p&gt;
&lt;h3&gt;Конфигурируем параметры пая&lt;/h3&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Выделяем минимальное количество видеопамяти&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;gpu_mem=16&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt

&lt;span class="c"&gt;# Выключаем модуль камеры&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;start_x=0&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt

&lt;span class="c"&gt;# Выключаем так называемые &amp;quot;вылеты развертки&amp;quot;, они не актуальны для современных телевизоров&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;disable_overscan=1&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt

&lt;span class="c"&gt;# Разгоняем (подробно можно почитать тут http://elinux.org/RPiconfig)&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;arm_freq=1000&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;core_freq=500&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;sdram_freq=600&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;over_voltage=6&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt

&lt;span class="c"&gt;# Форсируем Turbo режим в первые 60 секунд работы&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;initial_turbo=60&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt

&lt;span class="c"&gt;# Делает так, чтобы пай разгонялся только при необходимости&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;force_turbo=0&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /boot/config.txt
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h4&gt;Повышаем производительность&lt;/h4&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Улучшает производительность генератора случайных чисел&lt;/span&gt;
apt-get install -y rng-tools

&lt;span class="c"&gt;# Будет выдано сообщение о том, что скрипт не смог стартовать.&lt;/span&gt;
&lt;span class="c"&gt;# Ничего страшного, необходимый модуль станет доступен после перезагрузки&lt;/span&gt;
&lt;span class="nb"&gt;echo &lt;/span&gt;bcm2708-rng &amp;gt;&amp;gt; /etc/modules

&lt;span class="c"&gt;# Улучшает производительность служб управления памятью&lt;/span&gt;
apt-get install -y raspi-copies-and-fills

&lt;span class="c"&gt;# Можно настроить сеть на статику&lt;/span&gt;
&lt;span class="c"&gt;# [ОСТОРОЖНО, нужно быть уверенным в написанном, иначе можно потерять доступ по SSH]&lt;/span&gt;
&lt;span class="c"&gt;# Заменяем dhcp&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/iface eth0 inet dhcp/#iface eth0 inet dhcp/g&amp;#39;&lt;/span&gt; /etc/network/interfaces
&lt;span class="c"&gt;# На что-то вроде такого, но специфичного для вашей сети&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;iface eth0 inet static&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/network/interfaces
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;address 192.168.1.100&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/network/interfaces
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;gateway 192.168.1.1&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/network/interfaces
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;netmask 255.255.255.0&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/network/interfaces
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;network 192.168.1.0&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/network/interfaces
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;broadcast 192.168.1.255&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/network/interfaces
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h4&gt;Убираем лишнее&lt;/h4&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Оставляем один getty, т.к. работаем в основном по SSH&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;/[2-6]:23:respawn:\/sbin\/getty 38400 tty[2-6]/s%^%#%g&amp;#39;&lt;/span&gt; /etc/inittab
sed -i &lt;span class="s1"&gt;&amp;#39;/T0:23:respawn:\/sbin\/getty -L ttyAMA0 115200 vt100/s%^%#%g&amp;#39;&lt;/span&gt; /etc/inittab

&lt;span class="c"&gt;# Выключаем ipv6&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;net.ipv6.conf.all.disable_ipv6=1&amp;quot;&lt;/span&gt; &amp;gt; /etc/sysctl.d/disableipv6.conf
sed -i &lt;span class="s1"&gt;&amp;#39;/::/s%^%#%g&amp;#39;&lt;/span&gt; /etc/hosts

&lt;span class="c"&gt;# Выключаем неиспользуемые модули ядра&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;blacklist ipv6&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/modprobe.d/raspi-blacklist.conf
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;blacklist spi-bcm2708&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/modprobe.d/raspi-blacklist.conf
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;blacklist i2c-bcm2708&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/modprobe.d/raspi-blacklist.conf
chmod &lt;span class="m"&gt;644&lt;/span&gt; /etc/modprobe.d/raspi-blacklist.conf

&lt;span class="c"&gt;# Планировщик ввода/вывода &amp;quot;noop&amp;quot; лучше подходит для флеш памяти&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/deadline/noop/g&amp;#39;&lt;/span&gt; /boot/cmdline.txt
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h4&gt;Тюним файловую систему&lt;/h4&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# noatime и nodiratime отключают запись информации&lt;/span&gt;
&lt;span class="c"&gt;# о последнем времени доступа к файлам и директориям&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/errors=remount-ro,noatime /errors=remount-ro,noatime,nodiratime /g&amp;#39;&lt;/span&gt; /etc/fstab

&lt;span class="c"&gt;# Разрешаем автоматически восстанавливать файловые системы при загрузке,&lt;/span&gt;
&lt;span class="c"&gt;# если с ними что-то не так&lt;/span&gt;
sed -i &lt;span class="s2"&gt;&amp;quot;s/#FSCKFIX=no/FSCKFIX=yes/g&amp;quot;&lt;/span&gt; /etc/default/rcS

&lt;span class="c"&gt;# Каждые 3 перезагрузки проверяем главный раздел файловой системы&lt;/span&gt;
tune2fs -c &lt;span class="m"&gt;3&lt;/span&gt; /dev/mmcblk0p2

&lt;span class="c"&gt;# writeback тип записи в журнал дает больше производительности.&lt;/span&gt;
&lt;span class="c"&gt;# однако при падении системы данные могут потеряться&lt;/span&gt;
&lt;span class="c"&gt;# [ВЫПОЛНЯТЬ ТОЛЬКО С ПОНИМАНИЕМ РИСКОВ]&lt;/span&gt;
tune2fs -o journal_data_writeback /dev/mmcblk0p2

&lt;span class="c"&gt;# Перезагружаемся&lt;/span&gt;
reboot
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h4&gt;Логгируем в&amp;nbsp;оперативной памяти&lt;/h4&gt;
&lt;p&gt;Это, во-первых, увеличит производительность, во-вторых, снизит нагрузку на&amp;nbsp;SD карту. Для этого воспользуемся утилитой &lt;a href="http://www.tremende.com/ramlog/"&gt;&lt;code&gt;ramlog&lt;/code&gt;&lt;/a&gt;. Но, если у&amp;nbsp;вас в&amp;nbsp;системе демонами рулит &lt;code&gt;systemd&lt;/code&gt;&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;например, потому что вы&amp;nbsp;установили Debian 8 Jessie), то&amp;nbsp;ничего не&amp;nbsp;получится&amp;nbsp;&amp;mdash; &lt;code&gt;ramlog&lt;/code&gt;, по&amp;nbsp;крайней мере в&amp;nbsp;версии 2.0.0, не&amp;nbsp;совместим с&amp;nbsp;ним.&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Скачиваем и устанавливаем ramlog&lt;/span&gt;
&lt;span class="nb"&gt;cd&lt;/span&gt; /tmp
wget http://www.tremende.com/ramlog/download/ramlog_2.0.0_all.deb
apt-get install -y lsof rsync &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; dpkg -i ramlog_2.0.0_all.deb

&lt;span class="c"&gt;# Задаем максимальный объем логов в памяти&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/TMPFS_RAMFS_SIZE=\t/TMPFS_RAMFS_SIZE=40m\t/g&amp;#39;&lt;/span&gt; /etc/default/ramlog

&lt;span class="c"&gt;# Говорим, что ramlog надо запускать/останавливать до/после rsyslog&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/# Provides: ramlog/# Provides: ramlog\n# X-Start-Before: rsyslog\n# X-Stop-After: rsyslog/g&amp;#39;&lt;/span&gt; /etc/init.d/ramlog

&lt;span class="c"&gt;# Дадим знать об этом автозагрузке&lt;/span&gt;
insserv -v /etc/init.d/ramlog

&lt;span class="c"&gt;# Теперь нужно 2 (!) раза перезагрузить пай&lt;/span&gt;
reboot

&lt;span class="c"&gt;# Проверить состояние ramlog можно так&lt;/span&gt;
/etc/init.d/ramlog status

&lt;span class="c"&gt;# Напоследок уберем абсолютно неважные логи крона про успешную авторизацию&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/(the &amp;quot;Additional&amp;quot; block)/(the &amp;quot;Additional&amp;quot; block)\nsession [success=1 default=ignore] pam_succeed_if.so service in cron quiet use_uid/g&amp;#39;&lt;/span&gt; /etc/pam.d/common-session-noninteractive
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h3&gt;Настраиваем фаервол&lt;/h3&gt;
&lt;p&gt;Рекомендую не&amp;nbsp;полениться и&amp;nbsp;сконфигурировать фаервол&amp;nbsp;&amp;mdash; это хороший способ повысить безопасность системы. Установим &lt;code&gt;iptables&lt;/code&gt;&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;самый популярный фаервол на&amp;nbsp;Debian подобных системах).&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1
2
3
4
5
6&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Устанавливаем iptables&lt;/span&gt;
apt-get install iptables

&lt;span class="c"&gt;# Скачиваем скрипт для управления демоном&lt;/span&gt;
wget http://git.io/vs7i5 -O /etc/init.d/iptables
chmod &lt;span class="m"&gt;755&lt;/span&gt; /etc/init.d/iptables &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; insserv -v /etc/init.d/iptables
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Теперь зададим несколько базовых правил &lt;code&gt;nano /etc/iptables.rules&lt;/code&gt;:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;*filter

&lt;span class="c"&gt;# Принимаем все пакеты для loopback трафика&lt;/span&gt;
-A INPUT -i lo -j ACCEPT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Allow all loopback traffic&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Запрещаем все, что на 127 сети и не использует loopback трафик&lt;/span&gt;
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Drop all traffic to 127 that doesnt use lo&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Принимаем все входящие пакеты от уже установленных соединений&lt;/span&gt;
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Allow all incoming on established connections&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Разрешаем весь исходящий трафик&lt;/span&gt;
-A OUTPUT -j ACCEPT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Accept all outgoing&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Разрешаем Ping&lt;/span&gt;
-A INPUT -p icmp -m icmp --icmp-type &lt;span class="m"&gt;8&lt;/span&gt; -j ACCEPT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Allow Ping&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# SSH &lt;/span&gt;
-A INPUT -p tcp -m tcp --dport &lt;span class="m"&gt;22&lt;/span&gt; -j ACCEPT

&lt;span class="c"&gt;# ... остальные нужные вам правила. По iptables очень много информации в сети&lt;/span&gt;

&lt;span class="c"&gt;# Все остальное отклонять. Эти две инструкции должны быть в конце файла&lt;/span&gt;
-A INPUT -j REJECT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Reject all incoming&amp;quot;&lt;/span&gt;
-A FORWARD -j REJECT -m comment --comment &lt;span class="s2"&gt;&amp;quot;Reject all forwarded&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Говорим фаерволу применить инструкции&lt;/span&gt;
COMMIT
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Также необходимо задать правила фаерволу перед поднятием сетевых интерфейсов:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1
2&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Немного правим файл /etc/network/interfaces&lt;/span&gt;
sed -i &lt;span class="s1"&gt;&amp;#39;s/iface lo inet loopback/iface lo inet loopback\npre-up iptables-restore &amp;lt; \/etc\/iptables.rules/g&amp;#39;&lt;/span&gt; /etc/network/interfaces
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Наконец, стартуем фаервол:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;/etc/init.d/iptables start
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;h4&gt;Баним ботов пачками с&amp;nbsp;помощью fail2ban&lt;/h4&gt;
&lt;p&gt;Если ваш пай будет смотреть наружу в&amp;nbsp;интернет, то&amp;nbsp;в&amp;nbsp;него точно начнут ломиться боты. Если у&amp;nbsp;вас в&amp;nbsp;SSH настроена авторизация по&amp;nbsp;ключу и&amp;nbsp;отключена возможность входа по&amp;nbsp;паролю, то&amp;nbsp;смысла в&amp;nbsp;fail2ban не&amp;nbsp;слишком много. Однако он&amp;nbsp;может работать не&amp;nbsp;только с&amp;nbsp;SSH, а&amp;nbsp;со&amp;nbsp;многими утилитами, поэтому всё&amp;nbsp;же стоит рассмотреть вариант его применения. Да&amp;nbsp;и&amp;nbsp;вообще приятно в&amp;nbsp;логах видеть &lt;code&gt;NOTICE [ssh] fckn.bot.ip.addr already banned&lt;/code&gt; :)&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Если не хотим заморачиваться с установкой последней версии fail2ban&lt;/span&gt;
&lt;span class="c"&gt;# то просто ставим пакет и переходим к следующему шагу&lt;/span&gt;
apt-get install -y fail2ban

&lt;span class="c"&gt;# Если хотим, будем ставить свежую версию из репозитория&lt;/span&gt;
&lt;span class="c"&gt;# fail2ban написан на питоне, поэтому нужно его установить&lt;/span&gt;
apt-get install -y python

&lt;span class="c"&gt;# Скачаем сам fail2ban&lt;/span&gt;
&lt;span class="c"&gt;# Можете посмотреть номер последней релизной версии тут&lt;/span&gt;
&lt;span class="c"&gt;# https://github.com/fail2ban/fail2ban/releases&lt;/span&gt;
&lt;span class="nb"&gt;cd&lt;/span&gt; /tmp
wget https://github.com/fail2ban/fail2ban/archive/0.9.2.tar.gz -O fail2ban.tar.gz

&lt;span class="c"&gt;# Разархивируем&lt;/span&gt;
mkdir fail2ban &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; tar -xzvf fail2ban.tar.gz -C ./fail2ban --strip-components&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="nb"&gt;cd &lt;/span&gt;fail2ban

&lt;span class="c"&gt;# Установим&lt;/span&gt;
python setup.py install

&lt;span class="c"&gt;# Скопируем скрипт для управления fail2ban демоном&lt;/span&gt;
cp ./files/debian-initd /etc/init.d/fail2ban
chmod &lt;span class="m"&gt;755&lt;/span&gt; /etc/init.d/fail2ban &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; insserv -v /etc/init.d/fail2ban
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Теперь создадим конфиг &lt;code&gt;nano /etc/fail2ban/jail.local&lt;/code&gt; с&amp;nbsp;примерно таким текстом:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="o"&gt;[&lt;/span&gt;DEFAULT&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="c"&gt;# Игнорировать запросы из нашей сети&lt;/span&gt;
&lt;span class="nv"&gt;ignoreip&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; 192.168.1.0/24

&lt;span class="c"&gt;# Наблюдаем за авторизацией по ssh&lt;/span&gt;
&lt;span class="c"&gt;# Я выставляю очень жесткие настройки, может быть разумнее сделать лояльнее&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;ssh&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="nv"&gt;enabled&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;true&lt;/span&gt;
&lt;span class="nv"&gt;port&lt;/span&gt;     &lt;span class="o"&gt;=&lt;/span&gt; ssh
&lt;span class="nv"&gt;filter&lt;/span&gt;   &lt;span class="o"&gt;=&lt;/span&gt; sshd
&lt;span class="nv"&gt;logpath&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; /var/log/auth.log
&lt;span class="c"&gt;# Наблюдать за IP в течение часа&lt;/span&gt;
&lt;span class="nv"&gt;findtime&lt;/span&gt;    &lt;span class="o"&gt;=&lt;/span&gt; 3600
&lt;span class="c"&gt;# Если 3 попытки входа неудачны&lt;/span&gt;
&lt;span class="nv"&gt;maxretry&lt;/span&gt;    &lt;span class="o"&gt;=&lt;/span&gt; 3
&lt;span class="c"&gt;# Бан на сутки&lt;/span&gt;
&lt;span class="nv"&gt;bantime&lt;/span&gt;     &lt;span class="o"&gt;=&lt;/span&gt; 86400
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Наконец, запустим fail2ban:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;/etc/init.d/fail2ban start
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Логи, чтобы посмотреть успешно прошло или нет, лежат тут:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;cat /var/log/fail2ban.log
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;На&amp;nbsp;этом, пожалуй, пока что остановимся. Спасибо, что дочитали :)&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Дмитрий Харитонов</dc:creator><pubDate>Mon, 24 Aug 2015 23:30:00 +0300</pubDate><guid>tag:dkharitonov.me,2015-08-24:blog/raspberry-pi-setup</guid><category>rpi</category><category>nix</category></item><item><title>Хороший JavaScript. Vol. 1 «Pimp your code»</title><link>http://dkharitonov.me/blog/nice-js-vol-1</link><description>&lt;p&gt;Как известно, JavaScript&amp;nbsp;&amp;mdash; язык-ошибка, язык-неочевидное поведение, язык-недоразумение. Причиной этому являлась необходимость в&amp;nbsp;середине 90 в&amp;nbsp;жесткие сроки получить мощный язык, позволяющий придать страницам больше возможностей. И&amp;nbsp;получили. Все проблемы&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;повсеместные глобальные переменные, область видимости переменных, неочевидные и&amp;nbsp;нелогичные приведения типов) зашиты в&amp;nbsp;JS глубоко и&amp;nbsp;надолго. Сейчас к&amp;nbsp;нам приближается ES6, который явно, но&amp;nbsp;не&amp;nbsp;достаточно кардинально улучшает ситуацию.&lt;/p&gt;
&lt;p&gt;С&amp;nbsp;другой стороны язык очень гибок и&amp;nbsp;никто не&amp;nbsp;запрещает обходить плохие стороны, использовать хорошие и&amp;nbsp;улучшать язык своими силами. Этим я&amp;nbsp;и&amp;nbsp;займусь в&amp;nbsp;серии заметок. Неизгладимое впечатление на&amp;nbsp;меня произвела книга&lt;span style="margin-right:0.44em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.44em;"&gt;&amp;laquo;&lt;/span&gt;&lt;a href="http://www.ozon.ru/context/detail/id/20217226/"&gt;JavaScript. Сильные стороны&lt;/a&gt;&amp;raquo; Дугласа Крокфорда, рекомендую к&amp;nbsp;прочтению&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;она совсем небольшая).&lt;/p&gt;
&lt;h2&gt;Объекты&lt;/h2&gt;
&lt;p&gt;Это один из&amp;nbsp;основных механизмов в&amp;nbsp;языке и, надо сказать, удачно реализованный. &lt;/p&gt;
&lt;p&gt;Всё&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;ну, примитивы не&amp;nbsp;совсем объекты, они неизменяемы) в&amp;nbsp;JS&amp;nbsp;&amp;mdash; объект. Объекты обладают прототипом, который и&amp;nbsp;сам является объектом со&amp;nbsp;своим набором свойств. К&amp;nbsp;прототипам можно относиться как к&amp;nbsp;базовым объектам, задающим начальную функциональность другим объектам. Разные объекты могут иметь один и&amp;nbsp;тот&amp;nbsp;же прототип. Каждый раз при изменении прототипа у&amp;nbsp;объекта все другие объекты с&amp;nbsp;этим&amp;nbsp;же прототипом получают его обновленную версию. Это достигается за&amp;nbsp;счет того, что объекты содержат не&amp;nbsp;копию, а&amp;nbsp;ссылку на&amp;nbsp;прототип. Такая реализация способствует экономии памяти и&amp;nbsp;скорости работы.&lt;/p&gt;
&lt;p&gt;Помимо прототипа у&amp;nbsp;объекта есть свои, эксклюзивные свойства. Имя свойства может совпадать с&amp;nbsp;именем свойства в&amp;nbsp;прототипе. Ситуация разрешается просто: JS&amp;nbsp;сначала поищет запрашиваемое свойство в&amp;nbsp;списке личных свойств объекта, а&amp;nbsp;если не&amp;nbsp;найдет, пойдет искать по&amp;nbsp;цепочке прототипов в&amp;nbsp;их&amp;nbsp;свойствах.&lt;/p&gt;
&lt;p&gt;Что можно со&amp;nbsp;всем этим делать?&lt;/p&gt;
&lt;h2&gt;Расширение функциональности на&amp;nbsp;лету&lt;/h2&gt;
&lt;p&gt;Как было сказано, почти все в&amp;nbsp;JS является объектом, в&amp;nbsp;том числе массивы&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;ага). Мы&amp;nbsp;всегда можем добавить объекту новое свойство. Давайте попробуем использовать это себе во&amp;nbsp;благо. &lt;/p&gt;
&lt;p&gt;Например, имеем список абзацев с&amp;nbsp;текстом на&amp;nbsp;странице. Помимо самих DOM элементов мы&amp;nbsp;хотим хранить рядом с&amp;nbsp;ними какую-то метаинформацию&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;к&amp;nbsp;примеру, UID абзаца). И&amp;nbsp;мы&amp;nbsp;должны уметь удалять и&amp;nbsp;вставлять абзацы в&amp;nbsp;произвольных местах. Работающий пример можно посмотреть &lt;a href="https://jsbin.com/qemaqo/edit?html,js,output"&gt;здесь&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Есть следующая страница:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="cp"&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;html&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;head&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;meta&lt;/span&gt; &lt;span class="na"&gt;charset=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;utf-8&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;title&amp;gt;&lt;/span&gt;Расширение функциональности на лету&lt;span class="nt"&gt;&amp;lt;/title&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;body&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;content&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;script&amp;gt;&lt;/span&gt;
&lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;onload&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="c1"&gt;// ... здесь JS тот, что ниже в статье ...&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Объявим массив, где будем хранить наши абзацы, и&amp;nbsp;опишем объект, который будет представлять абзац с&amp;nbsp;текстом и&amp;nbsp;дополнительной информацией.&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getElementById&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;content&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;blocks&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[];&lt;/span&gt;

&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;block_factory&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;meta&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;node&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;createElement&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;p&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
  &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;innerHTML&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;text&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="nx"&gt;meta&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nx"&gt;meta&lt;/span&gt;
  &lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Наша цель&amp;nbsp;&amp;mdash; абстрагироваться от&amp;nbsp;работы с&amp;nbsp;DOM и&amp;nbsp;иметь дело только с&amp;nbsp;моделью данных. Чтобы осуществлять вставку и&amp;nbsp;удаление в&amp;nbsp;массиве хорошо подойдет стандартный метод &lt;a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Array/splice"&gt;&lt;code&gt;splice&lt;/code&gt;&lt;/a&gt;. Но&amp;nbsp;есть проблема: нам всё-таки &lt;em&gt;нужно&lt;/em&gt; воздействовать на&amp;nbsp;DOM, чтобы изменения были видны &lt;nobr&gt;визуально :)&lt;/nobr&gt; Давайте &lt;em&gt;подправим&lt;/em&gt; метод &lt;code&gt;splice&lt;/code&gt;, но&amp;nbsp;только для массива &lt;code&gt;blocks&lt;/code&gt;:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deleteCount&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;block&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;insert&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Вставляем элемент на заданный индекс в DOM дереве&lt;/span&gt;
    &lt;span class="c1"&gt;// Текущий и последующие элементы будут сдвинуты «вперед»&lt;/span&gt;
    &lt;span class="nx"&gt;content&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;insertBefore&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;block&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;content&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;childNodes&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;

    &lt;span class="c1"&gt;// Эта конструкция вызывает оригинальный метод splice из прототипа массива&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;prototype&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deleteCount&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;block&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
  &lt;span class="p"&gt;};&lt;/span&gt;

  &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;remove&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Вызываем оригинальный метод splice&lt;/span&gt;
    &lt;span class="c1"&gt;// Он возвращает новый массив с удаленными элементами&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;deleted&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;prototype&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deleteCount&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="nx"&gt;deleted&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;forEach&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;removed&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
      &lt;span class="c1"&gt;// Удаляем элемент из DOM&lt;/span&gt;
      &lt;span class="nx"&gt;content&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;removeChild&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;removed&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;deleted&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="p"&gt;};&lt;/span&gt;

  &lt;span class="c1"&gt;// Вызываем функцию удаления или вставки в зависимости от аргументов&lt;/span&gt;
  &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;typeof&lt;/span&gt; &lt;span class="nx"&gt;block&lt;/span&gt; &lt;span class="o"&gt;===&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;undefined&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;?&lt;/span&gt; &lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nx"&gt;insert&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Для простоты реализации метод перестал поддерживать возможность вставки нескольких элементов разом. Ну&amp;nbsp;и&amp;nbsp;ладно.&lt;/p&gt;
&lt;p&gt;Теперь мы&amp;nbsp;можем работать с&amp;nbsp;моделью данных и&amp;nbsp;сразу видеть изменения в&amp;nbsp;DOM:&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1
2
3
4
5&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;block_factory&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Первый абзац&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;uid&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="p"&gt;}));&lt;/span&gt;
&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;block_factory&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Второй абзац&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;uid&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="p"&gt;}));&lt;/span&gt;
&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;block_factory&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Третий абзац&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;uid&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt; &lt;span class="p"&gt;}));&lt;/span&gt;
&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;block_factory&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Теперь это второй абзац&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;uid&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt; &lt;span class="p"&gt;}));&lt;/span&gt;
&lt;span class="nx"&gt;blocks&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;splice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// Удалим третий по счету абзац (с текстом &amp;#39;Второй абзац&amp;#39;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Наш метод &lt;code&gt;splice&lt;/code&gt; не&amp;nbsp;затрагивает прототипный метод&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;помните, выше я&amp;nbsp;писал, что у&amp;nbsp;объектов есть прототип, а&amp;nbsp;есть свои личные методы?), поэтому никаких проблем с&amp;nbsp;использование метода у&amp;nbsp;других массивов не&amp;nbsp;будет. Эта техника позволяет писать мощный, но&amp;nbsp;в&amp;nbsp;то&amp;nbsp;же время чистый, легко поддерживаемый код.&lt;/p&gt;
&lt;p&gt;Подобным образом можно добавлять недостающую функциональность и&amp;nbsp;к&amp;nbsp;прототипам объектов&lt;span style="margin-right:0.3em;"&gt; &lt;/span&gt;&lt;span style="margin-left:-0.3em;"&gt;(&lt;/span&gt;в&amp;nbsp;том числе стандартным):&lt;/p&gt;
&lt;table class="codehilitetable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt;1
2
3
4
5
6&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// Добавляем ко всем объектам типа String метод trim, если его нет&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;typeof&lt;/span&gt; &lt;span class="nb"&gt;String&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;prototype&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;trim&lt;/span&gt; &lt;span class="o"&gt;!==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;function&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="nb"&gt;String&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;prototype&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;trim&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sr"&gt;/^s+|s+$/g&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;В&amp;nbsp;следующей статье мы&amp;nbsp;продолжим работать с&amp;nbsp;прототипами и&amp;nbsp;посмотрим на&amp;nbsp;способы реализации наследования в&amp;nbsp;JavaScript.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Дмитрий Харитонов</dc:creator><pubDate>Thu, 20 Aug 2015 12:51:00 +0300</pubDate><guid>tag:dkharitonov.me,2015-08-20:blog/nice-js-vol-1</guid><category>js</category><category>series</category></item></channel></rss>