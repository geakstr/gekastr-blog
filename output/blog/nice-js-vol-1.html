<!DOCTYPE html>
<html lang="ru">
<head>
      <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width"/>
    <title>Хороший JavaScript. Vol. 1 «Pimp your code» ⋅ Блог Дмитрия Харитонова</title>
    <link rel="stylesheet" href="/theme/css/reset.css" />
    <link rel="stylesheet" href="/theme/css/common.css" />
    <link rel="stylesheet" href="/theme/css/pygment.css" />
    <link rel="stylesheet" href="/theme/css/style.css" />
<link href="http://dkharitonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Дмитрий Харитонов RSS Feed" />


    <meta name="tags" content="js" />
    <meta name="tags" content="series" />
</head>
<body>
<!-- Yandex.Metrika counter -->
<script>
(function(d, w, c) {
  (w[c] = w[c] || []).push(function() {
    try {
      w.yaCounter29914984 = new Ya.Metrika({
        id: 29914984,
        webvisor: true,
        clickmap: true,
        trackLinks: true,
        accurateTrackBounce: true,
        trackHash: true
      });
    } catch (e) {}
  });
  var n = d.getElementsByTagName("script")[0],
    s = d.createElement("script"),
    f = function() {
      n.parentNode.insertBefore(s, n);
    };
  s.type = "text/javascript";
  s.async = true;
  s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
  if (w.opera == "[object Opera]") {
    d.addEventListener("DOMContentLoaded", f, false);
  } else {
    f();
  }
})(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="//mc.yandex.ru/watch/29914984" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
<header id="header">
    <nav id="menu"><ul>
      <li><h1><a id="logo" href="/">Дмитрий Харитонов</a></h1></li>
      <li><span class="muted">⋅</span></li>
      <li><em><a href="/blog">Блог</a></em></li>
    </ul></nav>
</header>

<section id="content" class="article-page-content">
  <article class="post">
    <header class="header">
          <div class="readtime"><i class="sprite sprite-clock"></i> 7 мин. на прочтение</div>
      <h2 class="title"><em>Хороший JavaScript. Vol. 1 «Pimp your code»</em></h2>
      
    </header>
    <div class="body"><p>Как известно, JavaScript&nbsp;&mdash; язык-ошибка, язык-неочевидное поведение, язык-недоразумение. Причиной этому являлась необходимость в&nbsp;середине 90 в&nbsp;жесткие сроки получить мощный язык, позволяющий придать страницам больше возможностей. И&nbsp;получили. Все проблемы<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>повсеместные глобальные переменные, область видимости переменных, неочевидные и&nbsp;нелогичные приведения типов) зашиты в&nbsp;JS глубоко и&nbsp;надолго. Сейчас к&nbsp;нам приближается ES6, который явно, но&nbsp;не&nbsp;достаточно кардинально улучшает ситуацию.</p>
<p>С&nbsp;другой стороны язык очень гибок и&nbsp;никто не&nbsp;запрещает обходить плохие стороны, использовать хорошие и&nbsp;улучшать язык своими силами. Этим я&nbsp;и&nbsp;займусь в&nbsp;серии заметок. Неизгладимое впечатление на&nbsp;меня произвела книга<span style="margin-right:0.44em;"> </span><span style="margin-left:-0.44em;">&laquo;</span><a href="http://www.ozon.ru/context/detail/id/20217226/">JavaScript. Сильные стороны</a>&raquo; Дугласа Крокфорда, рекомендую к&nbsp;прочтению<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>она совсем небольшая).</p>
<h2>Объекты</h2>
<p>Это один из&nbsp;основных механизмов в&nbsp;языке и, надо сказать, удачно реализованный. </p>
<p>Всё<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>ну, примитивы не&nbsp;совсем объекты, они неизменяемы) в&nbsp;JS&nbsp;&mdash; объект. Объекты обладают прототипом, который и&nbsp;сам является объектом со&nbsp;своим набором свойств. К&nbsp;прототипам можно относиться как к&nbsp;базовым объектам, задающим начальную функциональность другим объектам. Разные объекты могут иметь один и&nbsp;тот&nbsp;же прототип. Каждый раз при изменении прототипа у&nbsp;объекта все другие объекты с&nbsp;этим&nbsp;же прототипом получают его обновленную версию. Это достигается за&nbsp;счет того, что объекты содержат не&nbsp;копию, а&nbsp;ссылку на&nbsp;прототип. Такая реализация способствует экономии памяти и&nbsp;скорости работы.</p>
<p>Помимо прототипа у&nbsp;объекта есть свои, эксклюзивные свойства. Имя свойства может совпадать с&nbsp;именем свойства в&nbsp;прототипе. Ситуация разрешается просто: JS&nbsp;сначала поищет запрашиваемое свойство в&nbsp;списке личных свойств объекта, а&nbsp;если не&nbsp;найдет, пойдет искать по&nbsp;цепочке прототипов в&nbsp;их&nbsp;свойствах.</p>
<p>Что можно со&nbsp;всем этим делать?</p>
<h2>Расширение функциональности на&nbsp;лету</h2>
<p>Как было сказано, почти все в&nbsp;JS является объектом, в&nbsp;том числе массивы<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>ага). Мы&nbsp;всегда можем добавить объекту новое свойство. Давайте попробуем использовать это себе во&nbsp;благо. </p>
<p>Например, имеем список абзацев с&nbsp;текстом на&nbsp;странице. Помимо самих DOM элементов мы&nbsp;хотим хранить рядом с&nbsp;ними какую-то метаинформацию<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>к&nbsp;примеру, UID абзаца). И&nbsp;мы&nbsp;должны уметь удалять и&nbsp;вставлять абзацы в&nbsp;произвольных местах. Работающий пример можно посмотреть <a href="https://jsbin.com/qemaqo/edit?html,js,output">здесь</a>.</p>
<p>Есть следующая страница:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Расширение функциональности на лету<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="c1">// ... здесь JS тот, что ниже в статье ...</span>
<span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table>

<p>Объявим массив, где будем хранить наши абзацы, и&nbsp;опишем объект, который будет представлять абзац с&nbsp;текстом и&nbsp;дополнительной информацией.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">blocks</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">var</span> <span class="nx">block_factory</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">node</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span>
    <span class="nx">meta</span><span class="o">:</span> <span class="nx">meta</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</td></tr></table>

<p>Наша цель&nbsp;&mdash; абстрагироваться от&nbsp;работы с&nbsp;DOM и&nbsp;иметь дело только с&nbsp;моделью данных. Чтобы осуществлять вставку и&nbsp;удаление в&nbsp;массиве хорошо подойдет стандартный метод <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Array/splice"><code>splice</code></a>. Но&nbsp;есть проблема: нам всё-таки <em>нужно</em> воздействовать на&nbsp;DOM, чтобы изменения были видны <nobr>визуально :)</nobr> Давайте <em>подправим</em> метод <code>splice</code>, но&nbsp;только для массива <code>blocks</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span class="nx">blocks</span><span class="p">.</span><span class="nx">splice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">deleteCount</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">insert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Вставляем элемент на заданный индекс в DOM дереве</span>
    <span class="c1">// Текущий и последующие элементы будут сдвинуты «вперед»</span>
    <span class="nx">content</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">start</span><span class="p">]);</span>

    <span class="c1">// Эта конструкция вызывает оригинальный метод splice из прототипа массива</span>
    <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">blocks</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">deleteCount</span><span class="p">,</span> <span class="nx">block</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Вызываем оригинальный метод splice</span>
    <span class="c1">// Он возвращает новый массив с удаленными элементами</span>
    <span class="kd">var</span> <span class="nx">deleted</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">blocks</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">deleteCount</span><span class="p">);</span>
    <span class="nx">deleted</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Удаляем элемент из DOM</span>
      <span class="nx">content</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">removed</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deleted</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// Вызываем функцию удаления или вставки в зависимости от аргументов</span>
  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">block</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">remove</span><span class="p">()</span> <span class="o">:</span> <span class="nx">insert</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</td></tr></table>

<p>Для простоты реализации метод перестал поддерживать возможность вставки нескольких элементов разом. Ну&nbsp;и&nbsp;ладно.</p>
<p>Теперь мы&nbsp;можем работать с&nbsp;нашей моделью данных и&nbsp;сразу влиять на&nbsp;DOM:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span class="nx">blocks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">block_factory</span><span class="p">(</span><span class="s1">&#39;Первый абзац&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">uid</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}));</span>
<span class="nx">blocks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">block_factory</span><span class="p">(</span><span class="s1">&#39;Второй абзац&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">uid</span> <span class="o">:</span> <span class="mi">2</span> <span class="p">}));</span>
<span class="nx">blocks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">block_factory</span><span class="p">(</span><span class="s1">&#39;Третий абзац&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">uid</span> <span class="o">:</span> <span class="mi">3</span> <span class="p">}));</span>
<span class="nx">blocks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">block_factory</span><span class="p">(</span><span class="s1">&#39;Теперь это второй абзац&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">uid</span> <span class="o">:</span> <span class="mi">4</span> <span class="p">}));</span>
<span class="nx">blocks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// Удалим третий по счету абзац (с текстом &#39;Второй абзац&#39;)</span>
</pre></div>
</td></tr></table>

<p>Наш метод <code>splice</code> не&nbsp;затрагивает прототипный метод<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>помните, выше я&nbsp;писал, что у&nbsp;объектов есть прототип, а&nbsp;есть свои личные методы?), поэтому никаких проблем с&nbsp;использование метода у&nbsp;других массивов не&nbsp;будет. Эта техника позволяет писать мощный, но&nbsp;в&nbsp;то&nbsp;же время чистый, легко поддерживаемый код.</p>
<p>Подобным образом можно добавлять недостающую функциональность и&nbsp;к&nbsp;прототипам объектов<span style="margin-right:0.3em;"> </span><span style="margin-left:-0.3em;">(</span>в&nbsp;том числе стандартным):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span class="c1">// Добавляем ко всем объектам типа String метод trim, если его нет</span>
<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trim</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trim</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^s+|s+$/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>В&nbsp;следующей статье мы&nbsp;продолжим работать с&nbsp;прототипами и&nbsp;посмотрим на&nbsp;способы реализации наследования в&nbsp;JavaScript.</p></div>
    <footer class="meta">
        <span class="tags">
          <a class="tag nodecor" href="/blog/tags/js">#<u>js</u></a>
          <a class="tag nodecor" href="/blog/tags/series">#<u>series</u></a>
        </span>
    </footer>
  </article>
</section>

<footer id="footer">
    <p>© 20 августа 2015, <a href="mailto:geakstr@me.com" rel="me">geakstr@me.com</a></p>
    <p class="fork-bomb">:(){ :|:& };:</p>
<ul class="share">
<li><a href="http://twitter.com/home?status=%D0%A5%D0%BE%D1%80%D0%BE%D1%88%D0%B8%D0%B9%20JavaScript.%20Vol.%201%20%C2%ABPimp%20your%20code%C2%BB%20http%3A//dkharitonov.me/blog/nice-js-vol-1" class="twitter" target="_blank" title="Поделиться в Twitter">В твитер</a></li>
<li class="splitter">⋅</li>
<li><a href="http://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=http%3A//dkharitonov.me/blog/nice-js-vol-1" class="facebook" target="_blank" title="Поделиться в Facebook">В фейсбук</a></li>
<li class="splitter">⋅</li>
<li><a href="https://plus.google.com/share?url=http%3A//dkharitonov.me/blog/nice-js-vol-1" class="google-plus nodecor" target="_blank" title="Поделиться в Google+"><u>В гугл</u>+</a></li>
<li class="splitter">⋅</li>
<li><a href="https://vk.com/share.php?url=http%3A//dkharitonov.me/blog/nice-js-vol-1" class="vk" target="_blank" title="Поделиться во ВКонтакте">В контакт</a></li>
<li class="splitter">⋅</li>
<li><a href="mailto:?subject=%D0%A5%D0%BE%D1%80%D0%BE%D1%88%D0%B8%D0%B9%20JavaScript.%20Vol.%201%20%C2%ABPimp%20your%20code%C2%BB&amp;body=http%3A//dkharitonov.me/blog/nice-js-vol-1" class="email" target="_blank" title="Поделиться через эл. почту">По почте</a></li>
</ul>
</footer>

</body>
</html>